---
import {
  Launcher,
  LauncherPreferences,
  LauncherSwitch,
  LauncherNav,
  LauncherLink,
} from 'accessible-astro-launcher'
import { Icon } from 'astro-icon/components'
import { getCollection } from 'astro:content'
import { BLOG_API_URL } from 'astro:env/server'
import themeConfig from '@theme-config'
import { slugify } from '@utils/slugify'

/**
 * Launcher preferences for accessibility and theme.
 * @type {Array<{ label: string, onAction: string }>}
 */
const launcherPreferenceItems = [
  {
    label: 'Dark mode',
    onAction: 'toggle-dark-mode',
  },
  {
    label: 'High contrast',
    onAction: 'toggle-high-contrast',
  },
  {
    label: 'Reduced motion',
    onAction: 'toggle-reduced-motion',
  },
]

/**
 * Maximum number of blog posts to show in the launcher.
 * @type {number}
 */
const maxLauncherBlogPosts = 30

/**
 * Truncate blog post title to the first four words.
 * Used for generating short labels/URLs for launcher items.
 *
 * @param {string} title
 * @returns {string}
 */
const truncateBlogTitle = (title: string): string => {
  return title.split(' ').slice(0, 4).join(' ')
}

/**
 * Blog items for the launcher, fetched from `BLOG_API_URL`.
 * Shows up to `maxLauncherBlogPosts` items.
 *
 * @type {Array<{ label: string, href: string }>}
 */
const launcherBlogItems = await (async () => {
  if (!BLOG_API_URL) return []

  try {
    const response = await fetch(BLOG_API_URL)
    if (!response.ok) {
      console.warn(`Failed to fetch blog posts: ${response.status} ${response.statusText}`)
      return []
    }

    const data = (await response.json()) as Array<{ title: string }>

    return data.slice(0, maxLauncherBlogPosts).map((post) => {
      const truncatedTitle = truncateBlogTitle(post.title)
      const shortUrl = slugify(truncatedTitle)

      return {
        label: truncatedTitle,
        href: `/blog/${shortUrl}`,
      }
    })
  } catch {
    return []
  }
})()

/**
 * Project items for the launcher, sourced from the 'projects' collection.
 *
 * @type {Array<{ label: string, href: string, keywords: Array<string> }>}
 */
const launcherProjectItems = (await getCollection('projects')).map((project) => ({
  label: project.data.title,
  href: `/portfolio/${project.id}`,
  keywords: [project.data.author, ...project.data.tags],
}))

/**
 * Navigation items for the launcher, built from `themeConfig.navigation.items`.
 * Flattens dropdowns and applies external flags.
 *
 * @type {Array<{ label: string, href: string, external?: boolean }>}
 */
const launcherNavigationItems = themeConfig.navigation.items.flatMap((item) => {
  if (item.excludeFromLauncher) {
    return []
  }

  if (item.type === 'dropdown') {
    return item.items.map((subItem) => ({
      label: subItem.label,
      href: subItem.href,
      external: subItem.external ?? false,
    }))
  }

  if (!item.type || item.type === 'link') {
    return [
      {
        label: item.label,
        href: item.href,
        external: item.external ?? false,
      },
    ]
  }

  return []
})

/**
 * Social items for the launcher, from `themeConfig.socials`.
 *
 * @type {Array<{ label: string, href: string, icon: string, external?: boolean }>}
 */
const launcherSocialItems = (themeConfig.socials ?? []).map((item) => ({
  label: item.label,
  href: item.href,
  icon: item.icon,
  external: item.external ?? false,
}))

const launcherAccessibleAstroProjects = [
  {
    label: 'Accessible Astro Starter',
    href: 'https://github.com/incluud/accessible-astro-starter',
  },
  {
    label: 'Accessible Astro Dashboard',
    href: 'https://github.com/incluud/accessible-astro-dashboard',
  },
  {
    label: 'Accessible Astro Components',
    href: 'https://github.com/incluud/accessible-astro-components',
  },
  {
    label: 'Accessible Astro Docs',
    href: 'https://github.com/incluud/accessible-astro-docs',
  },
  {
    label: 'Accessible Astro Launcher',
    href: 'https://github.com/incluud/accessible-astro-launcher',
  },
  {
    label: 'Color Contrast Checker',
    href: 'https://github.com/incluud/color-contrast-checker',
  },
]
---

<Launcher id="site-launcher">
  <LauncherPreferences label="Preferences">
    {
      launcherPreferenceItems.map((item) => (
        <LauncherSwitch label={item.label} onAction={item.onAction} />
      ))
    }
  </LauncherPreferences>
  <LauncherNav label="Navigate to">
    {
      launcherNavigationItems.map((item) => (
        <LauncherLink
          label={item.label}
          href={item.href}
          {...(item.external ? { target: '_blank', rel: 'noopener noreferrer' } : {})}
        />
      ))
    }
  </LauncherNav>
  {
    launcherBlogItems.length > 0 && (
      <LauncherNav label="Blog posts">
        {launcherBlogItems.map((item) => (
          <LauncherLink label={item.label} href={item.href}>
            <Icon slot="icon" aria-hidden="true" name="lucide:scroll-text" size="16" />
          </LauncherLink>
        ))}
      </LauncherNav>
    )
  }
  {
    launcherProjectItems.length > 0 && (
      <LauncherNav label="Projects">
        {launcherProjectItems.map((item) => (
          <LauncherLink label={item.label} href={item.href} keywords={item.keywords}>
            <Icon slot="icon" aria-hidden="true" name="lucide:bookmark" size="16" />
          </LauncherLink>
        ))}
      </LauncherNav>
    )
  }
  {
    launcherAccessibleAstroProjects.length > 0 && (
      <LauncherNav label="Accessible Astro Projects">
        {launcherAccessibleAstroProjects.map((item) => (
          <LauncherLink label={item.label} href={item.href}>
            <Icon slot="icon" aria-hidden="true" name="lucide:external-link" size="16" />
          </LauncherLink>
        ))}
      </LauncherNav>
    )
  }
  {
    launcherSocialItems.length > 0 && (
      <LauncherNav label="Socials">
        {launcherSocialItems.map((item) => (
          <LauncherLink
            label={item.label}
            href={item.href}
            {...(item.external ? { target: '_blank', rel: 'noopener noreferrer' } : {})}
          >
            <Icon slot="icon" aria-hidden="true" name={item.icon} size="16" />
          </LauncherLink>
        ))}
      </LauncherNav>
    )
  }
</Launcher>
